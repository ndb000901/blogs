# Mysql基础-B+树

MySQL（InnoDB）使用 **B+ 树（B+Tree）** 作为其主要索引结构，特别是聚簇索引（Clustered Index）和辅助索引（Secondary Index）。

---

## 1. B+ 树

**B+ 树（B+Tree）** 是一种 **多路平衡查找树**，是 B 树的变体，适合**磁盘存储和范围查询**。

### 与 B 树相比的区别：

| 特性                 | B 树                     | B+ 树                            |
|----------------------|--------------------------|----------------------------------|
| 数据存储位置         | 所有节点都存数据         | 只有**叶子节点**存储数据       |
| 范围查询效率         | 差                      | 高（叶子节点有链表）            |
| 非叶子节点是否存数据 | 是                      | 否（只存键值做导航）            |
| 查询访问路径         | 可能结束在中间节点       | 一定走到**叶子节点**           |

---

## 2. B+ 树结构示意图

```
         +-------+
         |  30   |
         +-------+
        /         \
 +--------+    +--------+
 |10|20|29|    |31|40|50|
 +--------+    +--------+
   |  |  |        |  |  |
  -- -- --       -- -- --
（叶子节点）→（叶子节点）→（叶子节点）
（含数据）    （含数据）    （含数据）
```

> 叶子节点通过双向链表相连，方便范围查询。

---

## 3. 为什么 MySQL 用的是 B+ 树而不是 Hash、AVL、红黑树？

| 数据结构 | 难以适用的原因                                            |
|----------|-----------------------------------------------------------|
| Hash     | 无序，无法进行范围查询                                     |
| AVL/红黑 | 高度较高，频繁磁盘 IO 成本大                               |
| B+Tree   | 高扇出，低高度，适合磁盘块访问和范围查询                 |

---

## 4.InnoDB 中的 B+ 树类型

InnoDB 中有 **两种 B+ 树索引**：

### 4.1 聚簇索引（Clustered Index）

- 主键索引就是聚簇索引
- 叶子节点存储的是 **完整数据行**
- 数据根据主键排序存储在叶子节点

> 每张 InnoDB 表**只能有一个**聚簇索引

### 4.2 辅助索引（Secondary Index）

- 非主键、普通索引、唯一索引都属于辅助索引
- 叶子节点存储的是 **主键值**（不是整行）
- 需要 **回表** 查询原始数据

---

## 5. B+ 树索引访问路径（定位流程）

### 5.1 查询主键：

```sql
SELECT * FROM user WHERE id = 100;
```

- 直接在聚簇索引 B+ 树中查找 `id=100` 对应的叶子节点
- 命中后返回整行数据

### 5.2 查询辅助索引：

```sql
SELECT * FROM user WHERE name = 'Tom';
```

- 先走 name 的辅助 B+ 树，找到主键 `id=100`
- 再去主键 B+ 树中查 `id=100`，回表

---

## 6. B+ 树的设计优势

| 优势           | 说明 |
|----------------|------|
| 高扇出          | 一个节点可存上百条 key，树高低（通常只有 3~4 层）|
| 磁盘友好        | 每层查找都命中一页（如16KB），减少 I/O 次数 |
| 支持范围查询    | 叶子节点链表可高效扫描                       |
| 顺序遍历快      | 适合 `ORDER BY` 或 `BETWEEN` 等语句          |

---

## 7. B+ 树的页面结构（页 = node）

每一个 B+ 树节点（页） = InnoDB 页（16KB）

| 页类型 | 内容                                  |
|--------|----------------------------------------|
| 根页   | 树的入口，可能是非叶或叶               |
| 内部页 | 只存 key 和 child 页指针                |
| 叶子页 | 存实际数据（聚簇索引）或主键值（辅助索引）|

---

## 8. B+ 树页内是如何存储的？

页内数据使用 **行目录 + Slot 数组 + 指针数组** 进行有序管理。

页结构如下：

```
+--------------+ ← 页头信息（Page Header）
| Slot Array   | ← 指针数组，指向实际记录偏移
+--------------+
| 记录区域     |
| ...          |
+--------------+
| Free Space   |
+--------------+
```

页内排序依赖 slot array 的重排，不改动实际记录内容。

---

## 9. B+ 树与索引类型对应关系

| MySQL 索引语句               | 类型            | 结构                                      |
|-----------------------------|-----------------|-------------------------------------------|
| `PRIMARY KEY(id)`          | 聚簇索引         | B+树，叶子节点存整行                      |
| `UNIQUE(name)`             | 唯一辅助索引     | B+树，叶子存主键值                        |
| `INDEX(age)`               | 普通辅助索引     | B+树，叶子存主键值                        |
| `FULLTEXT()`、`SPATIAL()` | 特殊索引（非B+） | 使用倒排索引、R树                         |

---

## 10. 索引生效

- 索引字段使用了函数，如 `WHERE LEFT(name, 1) = 'T'`
- 使用 `OR` 且两边字段不同（无法使用联合索引）
- 隐式类型转换，如 `WHERE phone = 123456`（字段是字符串）
- 范围查询 + 索引后缀字段无法使用（联合索引中）

---





