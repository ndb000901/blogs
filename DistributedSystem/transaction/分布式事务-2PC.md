# 分布式事务-2PC


把一次跨多个节点的提交操作，拆成两个阶段：**先“准备”，再“提交”**，确保所有参与节点都达成一致，要么都成功，要么都失败。

---

## 1. 角色介绍

- **协调者（Coordinator）**：发起者，控制事务流程（通常是应用或中间件）
- **参与者（Participants）**：事务中的各个节点（如多个数据库、微服务）

---

## 2. 工作流程

### 第一阶段：**准备阶段（Prepare Phase）**

协调者发送 `prepare` 请求，所有参与者执行以下操作：

1. 执行本地事务（不提交）
2. 记录 undo 日志
3. 锁住资源（如数据库锁、缓存锁）
4. 返回结果：`ready` 或 `abort`

如果所有参与者返回 `ready`，则进入第二阶段；否则中止。

---

### 第二阶段：**提交/回滚阶段（Commit/Rollback Phase）**

协调者根据第一阶段的结果：

- 所有参与者都 `ready` → 发送 `commit`
- 有任何一个失败 → 发送 `rollback`

参与者收到指令后：

- `commit`：提交事务，释放锁，清除 undo 日志
- `rollback`：回滚事务，释放锁，撤销本地更改

---


## 3. 优点

- 强一致性（所有节点结果一致）
- 实现逻辑简单，思想清晰
- 被数据库原生支持（如 MySQL XA、PostgreSQL、Oracle）

---

## 4. 缺点

1. **阻塞问题**
    - 如果协调者挂了，参与者长时间无法释放资源，造成锁等待或死锁

2. **单点问题**
    - 协调者挂了，没有容灾机制会卡住整个事务

3. **无法处理网络分区**
    - 如果参与者提交完断网，协调者收不到响应，事务状态不确定

4. **性能差**
    - 参与者在第一阶段要持锁直到提交完成，影响并发性能

5. **资源浪费**
    - 即使失败也需要锁资源、写日志，增加系统负担

---



## 5. XA事务（MySQL 的 2PC 实现）

在 MySQL 中，XA 分布式事务的使用：

```sql
XA START 'xid';
-- 执行SQL
INSERT INTO orders VALUES (...);
XA END 'xid';

XA PREPARE 'xid';
-- 如果准备成功
XA COMMIT 'xid';
-- 否则
XA ROLLBACK 'xid';
```

可以通过中间件控制多个数据库事务的 XA 流程，协调提交。

---

## 6. 和其他分布式事务方案对比

| 特点           | 2PC              | TCC               | SAGA              |
|----------------|------------------|-------------------|-------------------|
| 一致性         | 强一致           | 最终一致          | 最终一致          |
| 是否阻塞       | 是               | 否                | 否                |
| 是否幂等要求   | 一般要求较少     | 高                | 高                |
| 性能           | 差               | 中                | 高                |
| 实现复杂度     | 低~中            | 高                | 中~高             |
| 资源消耗       | 高（锁资源）     | 中（预留资源）    | 低（补偿型）      |

---

