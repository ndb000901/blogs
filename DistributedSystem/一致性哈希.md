# 一致性哈希

一致性哈希（**Consistent Hashing**）是分布式系统中经典的哈希算法，广泛用于**分布式缓存、负载均衡、分布式存储（如分布式数据库、对象存储）**等场景，解决数据在节点之间**均匀分布**与**动态增删节点时数据迁移量**的问题。

---

## 1. 背景与问题

### 普通 Hash 分布的问题（取模法）
```text
hash(key) % N
```
- `key` 通过 hash 映射到 `[0, N)` 的某个节点上。
- 但如果节点数量 `N` 变化（例如新增/删除节点），则大多数 key 的位置都会改变 → **大量数据迁移**。

---

## 2. 一致性哈希核心思想

### 核心概念：
- 将整个哈希空间抽象为一个 **环**（称为哈希环），比如 0 ~ 2^32-1。
- 节点和数据通过相同的哈希函数映射到环上的位置。
- 一个数据 key 被映射到**顺时针方向上第一个“节点”** 所负责。

---

### 举例

假设哈希空间是 `0 ~ 2³²-1`，有如下节点：
- 节点 A → hash(A)
- 节点 B → hash(B)
- 节点 C → hash(C)

我们把这些节点按顺时针方向放在环上。
然后某个 key，比如 `user123` → `hash(user123)` 落在环上，顺时针查找第一个节点，比如落在 A 和 B 之间，就归 B 管。

---

### 节点变动的影响

#### 添加节点 D：
- 只有落在 D 的前一个节点与 D 之间的数据会被重新分配，其他数据不变。
- **迁移数据量 ≈ 1/N**

#### 删除节点 B：
- 只有原来属于 B 的 key 会被迁移到 B 的下一个节点。

相比取模法，这种方式对系统影响非常小，**天然适合节点动态上下线的分布式环境**。

---

## 3. 虚拟节点（Virtual Nodes）

实际使用时会遇到节点不均衡问题（节点分布不均导致负载不均）。

### 解决方案：
- 每个实际节点在哈希环上**映射多个虚拟节点（Replica）**，比如每个节点映射 100 个位置。
- 每个虚拟节点有不同名字（如 `A#0`, `A#1`, ...），各自独立 hash。
- 可以大幅提升负载均衡性，避免某些节点被 hash 函数过度命中。

---

