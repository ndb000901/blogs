# 消息认证码（MAC）

消息认证码（MAC）是一种用于确保消息完整性和真实性的加密技术，广泛应用于网络通信、数字签名、数据完整性验证等场景。

---

## **1.消息认证码**

消息认证码（MAC）是一个基于密钥的哈希值，它用于验证消息的完整性和身份认证。它是一种对称加密技术，意味着发送方和接收方共享相同的密钥。

**基本工作原理**：

1. 发送方使用密钥 `K` 计算消息 `M` 的 MAC 值：
   ```plaintext
   MAC = F(K, M)
   ```
   其中 `F` 是一个 MAC 计算函数。
2. 发送方将 `M` 和 `MAC` 一起发送给接收方。
3. 接收方收到消息后，使用相同的密钥 `K` 计算 MAC 值：
   ```plaintext
   MAC' = F(K, M)
   ```
4. 如果接收方计算出的 `MAC'` 与发送方提供的 `MAC` 匹配，则消息未被篡改，验证通过，否则拒绝消息。

---

## **2. 消息认证码的特性**

为了保证安全性，一个理想的 MAC 方案应该满足以下特性：

### **1. 完整性（Integrity）**

- 确保消息在传输过程中未被篡改。如果攻击者修改了消息 `M`，则 `MAC' ≠ MAC`，验证失败。

### **2. 认证性（Authenticity）**

- 由于 MAC 需要一个密钥 `K`，只有拥有该密钥的合法用户才能计算并验证 MAC。因此，它可用于身份认证，确保消息来自可信方。

### **3. 伪造抗性（Unforgeability）**

- 攻击者无法伪造一个合法的 MAC 值，而不知密钥 `K`。

### **4. 抗重放攻击**

- 结合时间戳或序列号，可以防止攻击者拦截并重复发送旧消息。

---

## **3. 常见的 MAC 方案**

### **1. 基于哈希函数的 MAC（HMAC）**

HMAC（Hashed Message Authentication Code）是一种基于哈希函数（如 SHA-256、SHA-512）的 MAC 方案。

**计算方式**：

```plaintext
HMAC(K, M) = H((K' ⊕ opad) ∥ H((K' ⊕ ipad) ∥ M))
```

其中：

- `H` 是哈希函数（如 SHA-256）
- `K'` 是密钥（如果 `K` 过长，则先进行哈希）
- `opad` 和 `ipad` 是填充常量
- `⊕` 代表异或运算（XOR）
- `∥` 代表字符串连接（Concatenation）

**优点**：

- 依赖于标准哈希函数（如 SHA-2），安全性较高。
- 计算高效，适用于多种应用场景（如 TLS、HTTPS）。

**应用**：

- TLS（Transport Layer Security）协议
- HTTPS 认证
- OAuth 协议的签名机制

---

### **2. 基于分组密码的 MAC（CMAC）**

CMAC（Cipher-based MAC）使用分组密码（如 AES）来计算 MAC。

**计算方式**：

- 使用 AES 加密 `M`，然后应用密钥派生函数来生成 MAC。
- 适用于 128 位密钥的安全环境。

**应用**：

- 无线安全协议（如 IEEE 802.11i）
- 现代支付系统

---

### **3. 基于流密码的 MAC（Poly1305）**

Poly1305 是一种基于流密码（如 ChaCha20）的 MAC 方案，主要用于高性能网络通信。

**应用**：

- TLS 1.3
- Google QUIC 协议
- 高速 VPN

---

## **4. 消息认证码 vs 数字签名**

| 特性           | MAC（消息认证码）         | 数字签名      |
| ------------ | ------------------ | --------- |
| **是否对称加密**   | 对称（共享密钥）           | 非对称（公私钥）  |
| **是否提供身份认证** | 需要共享密钥             | 通过公私钥认证   |
| **是否可否抵赖**   | 不可抵赖               | 可用于不可抵赖性  |
| **计算开销**     | 低                  | 高         |
| **常见算法**     | HMAC、CMAC、Poly1305 | RSA、ECDSA |

---

## **5. 常见的 MAC 攻击**

### **1. 伪造攻击**

- 如果 MAC 设计不安全，攻击者可以通过观察 MAC 输出尝试伪造合法消息的 MAC。
- **解决方案**：
  - 选择强加密算法，如 HMAC-SHA-256。
  - 使用足够长的密钥（128 位或以上）。

### **2. 长度扩展攻击**

- 某些 MAC 算法（如早期的 MD5-HMAC）可能受到长度扩展攻击，攻击者可以构造新的消息和 MAC 而不知密钥。
- **解决方案**：
  - 使用 HMAC-SHA-256，而不是直接使用哈希函数作为 MAC。

### **3. 中间人攻击（MITM）**

- 如果密钥管理不当，攻击者可能会拦截并篡改消息和 MAC。
- **解决方案**：
  - 结合 TLS 使用加密传输通道。

---

