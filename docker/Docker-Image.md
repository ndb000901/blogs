# Docker Image

Docker 镜像是一个只读的、**包含操作系统、程序、库、配置文件**等内容的文件系统快照，是启动 Docker 容器的模板。

可以把镜像理解为一个“蓝图”或“操作系统的最小发行版 + 应用”。

---

## 1. Docker 镜像的核心特性

| 特性 | 说明 |
|------|------|
| **分层结构（Layered）** | 每个镜像由多层只读层组成，底层越靠近基础镜像 |
| **不可变（Immutable）** | 一旦构建完成，不能被修改（只能通过创建新层） |
| **缓存机制（Build Cache）** | 构建过程中，每一步都作为一个层缓存 |
| **联合文件系统（Union FS）** | 镜像层 + 可写容器层组合在一起形成容器文件系统 |

---

## 2. 镜像构成结构图

```bash

镜像结构：
┌──────────────────────────┐
│ Layer 4: 应用代码层        │  ← Dockerfile: COPY . . 
├──────────────────────────┤
│ Layer 3: 安装依赖层        │  ← Dockerfile: RUN npm install
├──────────────────────────┤
│ Layer 2: 基础操作系统层    │  ← FROM node:18-alpine
├──────────────────────────┤
│ Layer 1: 最底层镜像        │  ← scratch 或更底层 OS
└──────────────────────────┘
```

镜像 + 容器层 = 容器运行时的文件系统

---

## 3. 镜像常用命令

### 3.1 镜像管理

```bash

docker images               # 列出所有本地镜像
docker image ls             # 同上
docker pull nginx:1.25      # 拉取镜像
docker rmi nginx:1.25       # 删除镜像
docker image rm <IMAGE ID>  # 同上
```

### 3.2 镜像构建与打包

```bash

docker build -t myapp:v1 .    # 根据当前目录的 Dockerfile 构建镜像
docker tag myapp:v1 myrepo/myapp:prod  # 镜像打标签
```

### 3.3 镜像导入导出

```bash

docker save -o myapp.tar myapp:v1      # 导出镜像为 tar 包
docker load -i myapp.tar               # 导入镜像
```

### 3.4 查看镜像信息

```bash

docker inspect myapp:v1      # 查看镜像详细 JSON 元数据
docker history myapp:v1      # 查看构建历史（层）
```

---

## 4. 镜像分层机制

Dockerfile 每个 `RUN`、`COPY`、`ADD` 指令都会生成一个 **只读层**。

这些层有以下特点：

- 会被缓存（提升构建速度）
- 多个镜像可共享相同层（节省磁盘）
- 多个容器可复用镜像层（只增加一个写层）

建议：
- 合并多个 `RUN` 指令减少层数
- 利用缓存机制（不要随意改变 COPY 顺序）

---

## 5. 优化镜像构建的技巧

| 技巧 | 描述 |
|------|------|
| 使用 **Alpine 镜像** | 极小（5MB），适合构建最小镜像 |
| 使用 `.dockerignore` | 排除不必要的文件（如 `.git`, `node_modules`） |
| 合并 `RUN` 命令 | 减少层数，提升构建效率 |
| 用 **多阶段构建** | 将编译与运行分离，只保留最终产物 |
| 最小权限运行 | 使用 `USER` 指令避免用 root 运行应用 |
| 合理使用缓存 | 修改频繁的 COPY 要放后面（避免失效缓存） |

---

## 6. 镜像 vs 容器的区别

| 对比项 | 镜像（Image） | 容器（Container） |
|--------|--------------|------------------|
| 是否可写 | 只读 | 有写层 |
| 状态 | 静态、模板 | 运行时、实例 |
| 创建方式 | Dockerfile 构建 | 基于镜像运行出来的进程 |
| 文件结构 | 多层堆叠 | 镜像层 + 写时层 |
| 使用场景 | 分发、构建 | 运行、部署 |

---
