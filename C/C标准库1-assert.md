# Cæ ‡å‡†åº“1-assert

### `assert.h` å¤´æ–‡ä»¶è¯¦è§£

`assert.h` æ˜¯ C è¯­è¨€æ ‡å‡†åº“ä¸­çš„ä¸€ä¸ªå¤´æ–‡ä»¶ï¼Œæä¾›äº† **`assert` æ–­è¨€å®**ï¼Œç”¨äºåœ¨è°ƒè¯•é˜¶æ®µæ£€æŸ¥ç¨‹åºä¸­çš„ä¸å˜é‡ï¼ˆinvariantsï¼‰æˆ–å‡è®¾ï¼ˆassumptionsï¼‰ï¼Œä»¥ä¾¿å°½æ—©å‘ç°é€»è¾‘é”™è¯¯ã€‚

---

## **1. `assert` å®çš„åŸºæœ¬ç”¨æ³•**
`assert` å®ç”¨äºæ£€æŸ¥ä¸€ä¸ªè¡¨è¾¾å¼æ˜¯å¦ä¸ºçœŸï¼ˆé 0ï¼‰ã€‚å¦‚æœè¡¨è¾¾å¼ä¸ºå‡ï¼ˆ0ï¼‰ï¼Œ`assert` ä¼šï¼š
- åœ¨ `stderr` è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼ŒåŒ…æ‹¬**æ–‡ä»¶å**ã€**è¡Œå·**å’Œ**æ–­è¨€å¤±è´¥çš„è¡¨è¾¾å¼**ã€‚
- ç»ˆæ­¢ç¨‹åºï¼ˆè°ƒç”¨ `abort()`ï¼‰ã€‚

### **è¯­æ³•**
```c
#include <assert.h>

void assert(int expression);
```

### **ç¤ºä¾‹**
```c
#include <assert.h>
#include <stdio.h>

int main() {
    int x = 5;
    assert(x > 0);   // é€šè¿‡ï¼Œç¨‹åºç»§ç»­æ‰§è¡Œ
    assert(x < 0);   // å¤±è´¥ï¼Œç¨‹åºç»ˆæ­¢å¹¶è¾“å‡ºé”™è¯¯ä¿¡æ¯
    printf("è¿™è¡Œä¸ä¼šæ‰§è¡Œ\n");
    return 0;
}
```
**è¿è¡Œè¾“å‡ºï¼ˆå½“ `assert(x < 0);` å¤±è´¥æ—¶ï¼‰ï¼š**
```
a.out: example.c:8: main: Assertion `x < 0' failed.
Aborted (core dumped)
```
> **æ³¨æ„ï¼š** `assert` å¤±è´¥æ—¶ä¼šç»ˆæ­¢ç¨‹åºï¼Œä¸ä¼šç»§ç»­æ‰§è¡Œåç»­ä»£ç ã€‚

---

## **2. `assert` çš„å·¥ä½œåŸç†**
`assert` å®åœ¨**ç¼–è¯‘æ—¶**ä¼šè¢«å±•å¼€æˆå¦‚ä¸‹å½¢å¼ï¼š
```c
#define assert(expr) ((expr) ? (void)0 : __assert_fail(#expr, __FILE__, __LINE__, __func__))
```
å…¶ä¸­ï¼š
- `#expr`ï¼šå­—ç¬¦ä¸²åŒ–å®ï¼ŒæŠŠ `expr` å˜æˆå­—ç¬¦ä¸²ï¼Œå¦‚ `"x < 0"`ã€‚
- `__FILE__`ï¼šå½“å‰æºæ–‡ä»¶åã€‚
- `__LINE__`ï¼šå‘ç”Ÿæ–­è¨€å¤±è´¥çš„è¡Œå·ã€‚
- `__func__`ï¼šå½“å‰å‡½æ•°åç§°ã€‚
- `__assert_fail()` æ˜¯ GNU C Library æä¾›çš„å†…éƒ¨å‡½æ•°ï¼Œå®ƒä¼šæ‰“å°é”™è¯¯ä¿¡æ¯å¹¶ç»ˆæ­¢ç¨‹åºã€‚

**ç­‰æ•ˆä»£ç **
```c
if (!(x < 0)) {
    fprintf(stderr, "%s:%d: %s: Assertion `%s` failed.\n",
            __FILE__, __LINE__, __func__, "x < 0");
    abort(); // ç»ˆæ­¢ç¨‹åº
}
```

---

## **3. é‡Šæ”¾æ¨¡å¼ (`NDEBUG`)**
åœ¨**å‘å¸ƒç‰ˆæœ¬**ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¸å¸Œæœ› `assert` å½±å“æ€§èƒ½ï¼Œå› æ­¤ C è¯­è¨€æ ‡å‡†å…è®¸æˆ‘ä»¬å®šä¹‰ `NDEBUG`ï¼ˆNo Debugï¼‰ï¼Œç¦ç”¨æ‰€æœ‰ `assert` è¯­å¥ï¼š
```c
#define NDEBUG
#include <assert.h>
```
> **æ•ˆæœï¼š** `assert(expr)` ç›´æ¥è¢«é¢„å¤„ç†å™¨ç§»é™¤ï¼Œä¸ä¼šå¯¹ `expr` è¿›è¡Œæ±‚å€¼ï¼Œé¿å…è¿è¡Œæ—¶å¼€é”€ã€‚

### **ç¤ºä¾‹**
```c
#include <stdio.h>
#include <assert.h>

int main() {
    int x = -1;

    assert(x >= 0);  // è‹¥æœªå®šä¹‰ NDEBUGï¼Œè¿™é‡Œä¼šç»ˆæ­¢ç¨‹åº

    printf("ç¨‹åºç»§ç»­è¿è¡Œ\n");
    return 0;
}
```
#### **ä¸åŒæƒ…å†µä¸‹çš„è¡Œä¸º**
| ä»£ç æ˜¯å¦å®šä¹‰ `#define NDEBUG` | `assert` æ–­è¨€è¡Œä¸º |
|------------------------------|----------------|
| æœªå®šä¹‰ `NDEBUG`               | `assert` å¤±è´¥ï¼Œç¨‹åºç»ˆæ­¢ |
| å®šä¹‰ `NDEBUG`                 | `assert` è¢«ç§»é™¤ï¼Œç¨‹åºæ­£å¸¸è¿è¡Œ |

> **å»ºè®®ï¼š** åœ¨**è°ƒè¯•é˜¶æ®µ**å¯ç”¨ `assert`ï¼Œåœ¨**æ­£å¼å‘å¸ƒæ—¶**ç”¨ `-DNDEBUG` å…³é—­ `assert`ã€‚

ç¼–è¯‘æ—¶ä½¿ç”¨ `gcc` å…³é—­ `assert`ï¼š
```sh
gcc -DNDEBUG program.c -o program
```

---

## **4. `assert` çš„ä½¿ç”¨åœºæ™¯**
### **âœ… é€‚åˆä½¿ç”¨ `assert` çš„æƒ…å†µ**
1. **æ£€æŸ¥ç¨‹åºçš„å†…éƒ¨ä¸å˜é‡**ï¼ˆå¦‚æŒ‡é’ˆã€æ•°ç»„ç´¢å¼•ï¼‰
2. **è°ƒè¯•æ—¶æ•è·æ„å¤–æƒ…å†µ**ï¼ˆå¦‚éæ³•å‚æ•°ï¼‰
3. **å¼€å‘é˜¶æ®µæ£€æŸ¥é€»è¾‘é”™è¯¯**
4. **å•å…ƒæµ‹è¯•**
5. **æ–‡æ¡£åŒ–ä»£ç å‡è®¾**

**ç¤ºä¾‹ï¼šé˜²æ­¢ç©ºæŒ‡é’ˆ**
```c
void process(int *ptr) {
    assert(ptr != NULL);  // ç¡®ä¿æŒ‡é’ˆä¸ä¸ºç©º
    *ptr = 10;
}
```

---

### **ğŸš« ä¸é€‚åˆä½¿ç”¨ `assert` çš„æƒ…å†µ**
1. **è¾“å…¥éªŒè¯**
   - `assert` ä¸»è¦ç”¨äºå¼€å‘è°ƒè¯•ï¼Œä¸åº”ç”¨äºç”¨æˆ·è¾“å…¥æ£€æŸ¥ã€‚
   - `assert` åœ¨ `NDEBUG` æ¨¡å¼ä¸‹ä¼šè¢«ç§»é™¤ï¼Œä¸èƒ½ä¿è¯å¯é æ€§ã€‚
   - åº”è¯¥ä½¿ç”¨ `if` è¯­å¥å’Œ `exit()` è¿›è¡Œè¾“å…¥éªŒè¯ã€‚

**é”™è¯¯ç¤ºèŒƒ**
```c
void read_input(int age) {
    assert(age > 0);  // âŒ ä¸åº”è¯¥ç”¨ assert
}
```
**æ­£ç¡®åšæ³•**
```c
void read_input(int age) {
    if (age <= 0) {
        fprintf(stderr, "Invalid age!\n");
        exit(EXIT_FAILURE);
    }
}
```

---

## **5. `assert` vs. `static_assert`**
C11 æ ‡å‡†å¼•å…¥äº† `static_assert`ï¼Œç”¨äº**ç¼–è¯‘æ—¶æ£€æŸ¥**ï¼š
```c
#include <assert.h>

static_assert(sizeof(int) == 4, "int ä¸æ˜¯ 4 å­—èŠ‚");
```
- **`assert(expr)`**ï¼šè¿è¡Œæ—¶æ£€æŸ¥ï¼Œå½±å“æ€§èƒ½ï¼Œ`NDEBUG` å¯å…³é—­ã€‚
- **`static_assert(expr, msg)`**ï¼šç¼–è¯‘æ—¶æ£€æŸ¥ï¼Œ`NDEBUG` ä¸å½±å“ã€‚

---

## **6. `assert` åœ¨ä¸åŒ C æ ‡å‡†ä¸­çš„æ”¯æŒ**
| æ ‡å‡†ç‰ˆæœ¬ | `assert.h` æ˜¯å¦æ”¯æŒ |
|---------|----------------|
| C89/C90 | âœ… æ”¯æŒ |
| C99     | âœ… æ”¯æŒ |
| C11     | âœ… æ”¯æŒï¼ˆæ–°å¢ `static_assert`ï¼‰ |
| C17     | âœ… æ”¯æŒ |

---

## **æ€»ç»“**
| å…³é”®ç‚¹ | è¯´æ˜ |
|--------|------|
| ä½œç”¨ | è¿è¡Œæ—¶æ£€æŸ¥è¡¨è¾¾å¼æ˜¯å¦ä¸ºçœŸï¼Œå¦åˆ™ç»ˆæ­¢ç¨‹åº |
| å¤±è´¥æ—¶ | è¾“å‡ºæ–‡ä»¶åã€è¡Œå·ã€è¡¨è¾¾å¼ï¼Œè°ƒç”¨ `abort()` |
| é¢„å¤„ç†å™¨æ§åˆ¶ | `#define NDEBUG` å¯ç¦ç”¨ `assert` |
| é€‚ç”¨åœºæ™¯ | è°ƒè¯•ã€æ£€æŸ¥å†…éƒ¨å‡è®¾ |
| ä¸é€‚ç”¨åœºæ™¯ | ç”¨æˆ·è¾“å…¥éªŒè¯ |
| `static_assert` | C11 æ–°å¢ï¼Œç¼–è¯‘æœŸæ£€æŸ¥ |
