# Sentinel 流控规则

Sentinel 的流控规则是其核心功能之一，用于控制系统的 **QPS（每秒请求数）**，防止某个资源被突发流量压垮。

---

## 1. 流控规则（FlowRule）

一个流控规则由以下几个字段组成：

| 字段名 | 作用 |
|--------|------|
| `resource` | 资源名（如接口名、方法名、URL 等） |
| `grade` | 阈值类型，0 表示 QPS，1 表示线程数 |
| `count` | 阈值：QPS 或线程数上限 |
| `strategy` | 流控模式：直接、关联、链路 |
| `controlBehavior` | 流控效果：快速失败、匀速排队、预热等 |
| `limitApp` | 限流针对的调用来源（默认是 default，表示不区分来源）|

---


### 1.1 resource（资源名）

代表受保护的资源，通常是：
- 方法名（用于 `@SentinelResource`）
- URL 路径（自动注册）
- 自定义字符串（如 `SphU.entry("myService")`）

---

### 1.2 grade（限流类型）
| 值 | 类型 | 含义 |
|----|------|------|
| `0` | QPS | 每秒通过的请求数限制 |
| `1` | 线程数 | 当前正在处理的请求线程数限制（并发控制）|

---

### 1.3 count（限流阈值）
- 当 QPS 超过 `count` 时触发限流
- 当线程数超过 `count` 时触发限流

---

## 2. strategy（流控模式）

用于决定 *以什么为依据来判断限流*。

| 值 | 名称 | 含义 |
|----|------|------|
| `0` | 直接（Direct） | 直接对当前资源做限流 |
| `1` | 关联（Associated） | 当**关联资源**达到阈值时，限流当前资源 |
| `2` | 链路（Chain） | 只在某个调用链路上做限流（方法嵌套调用时使用）|

---

## 3. controlBehavior（流控效果）

决定被限流的请求**怎么处理**。

| 值 | 名称 | 含义 |
|----|------|------|
| `0` | 快速失败（默认） | 超出阈值直接拒绝 |
| `1` | Warm Up | 预热模式，应用刚启动时 QPS 会慢慢提升 |
| `2` | 匀速排队 | 类似漏桶算法，让流量匀速通过（牺牲响应速度）|

### 说明：
- **快速失败**：高并发下响应最快，适合大多数业务。
- **预热**：适合缓存或系统刚启动时不希望瞬间被压垮。
- **匀速排队**：类似令牌桶，用于对请求做节流。

---

## 4. limitApp（调用来源）

表示对**谁进行限流**：

| 值 | 含义 |
|----|------|
| `default` | 不区分来源，所有调用都计数 |
| 应用名 | 限制来自某个服务的请求 |
| `other` | 限制非在白名单内的应用 |

> 在微服务系统中，`limitApp` 用于对调用方做限流，例如 A 服务调用 B 服务接口时，B 可以只限制 A。

---



---



## 5. 建议

| 场景 | 推荐配置 |
|------|----------|
| 接口有明显峰值，需要保护 | QPS + 快速失败 |
| 应用冷启动容易被压死 | 预热模式 |
| 系统必须匀速处理 | 匀速排队（牺牲时延） |
| 接口 A 的访问要看接口 B 的压力 | 关联限流 |
| 同一个方法在不同调用链中不同限流 | 链路限流 |

