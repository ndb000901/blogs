# Redis基础-HyperLogLog


## 1. HyperLogLog 

**HyperLogLog** 是一种用于**基数统计（cardinality estimation）** 的数据结构，适用于统计 **“某个集合中不重复元素的数量”**，例如：

- 网站 UV（独立访客数）
- IP 数量
- 注册用户数
- 搜索关键词数

---

特点

- **极致省内存！** 无论你统计 10 个还是 10 亿个不同元素，HyperLogLog 始终只占用大约 **12KB** 内存。
- 是一种**概率性数据结构**，结果是**近似值**，标准误差约为 **0.81%**。

---

## 2. 工作原理

HyperLogLog 的核心思想基于**散列函数 + 前导零计数**：

1. 每个元素通过 hash 函数变成一个 64 位的二进制数。
2. 将 hash 值分为前缀和后缀，前缀决定桶编号（Redis 默认 2¹⁴ = 16384 个桶）。
3. 后缀用于统计该值的前导零个数。
4. 每个桶记录见过的最大前导零个数。
5. 通过数学算法（调和平均 + 常量 α）估算集合的基数。

> 越多不同元素出现，越可能出现更长的前导零，从而提升估算值。

---

## 3. 常用命令

### 3.1 添加元素

```bash

PFADD key element [element ...]
```

示例：

```bash

PFADD hll:users user_1
PFADD hll:users user_2 user_3
```

> 如果添加的是重复元素，不会影响结果。

---

### 3.2 获取估算的唯一元素个数

```bash

PFCOUNT key [key ...]
```

示例：

```bash

PFCOUNT hll:users
```

支持对多个 HyperLogLog 合并后统计总量：

```bash

PFCOUNT hll:users_day1 hll:users_day2
```

---

### 3.3 合并多个 HyperLogLog

```bash

PFMERGE destkey sourcekey [sourcekey ...]
```

示例：

```bash

PFMERGE hll:week hll:mon hll:tue hll:wed
```

会将多个源 HyperLogLog 合并到一个目标中。

---

## 4. 优势

| 优势         | 说明 |
|--------------|------|
| 占用极少内存 | 始终大约 12KB |
| 支持去重统计 | 自动处理重复数据 |
| 合并能力强   | 可跨多个 key 合并数据 |

---

## 5. 局限与注意事项

| 限制/注意点      | 说明 |
|------------------|------|
| 只能做基数估计    | 无法获取实际元素内容（不像 Set） |
| 是**近似值**     | 精度误差约 ±0.81%，不适合精确计费场景 |
| 不支持删除元素    | 添加后不可移除，除非重建 |
| 不支持更新元素值 | 无意义，因为重复元素被忽略 |
| 不适合统计少量数据 | 小量数据时误差较大（如 <1000） |

---
