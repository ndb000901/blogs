# 文件上传漏洞

文件上传漏洞是 Web 安全中非常常见、危害非常大的漏洞类型之一。它通常发生在应用允许用户上传文件（如头像、附件、PDF 等）但没有**严格验证文件内容与行为**，导致攻击者可以上传**恶意脚本（如木马、WebShell）**，进而远程控制服务器。

---

## 1. 文件上传漏洞

文件上传漏洞是指：**应用在处理用户上传文件时，没有对文件类型、扩展名、内容、大小、路径等做严格校验，导致攻击者能够上传可被服务器执行的恶意文件（如 PHP 脚本、JSP 木马等）**。

一旦上传成功并能执行，攻击者可能直接入侵服务器。

---

## 2. 攻击流程

1. **上传点存在**  
   用户可以上传头像、简历、图片等文件

2. **绕过文件限制**
   通过改扩展名、伪造 Content-Type、双扩展等绕过检查

3. **服务器保存文件**
   文件被写入到可被 Web 访问的目录（如 `/uploads/`）

4. **访问触发**
   攻击者访问上传的 WebShell，例如：
   ```
   http://example.com/uploads/shell.php
   ```

5. **执行攻击**
   利用 WebShell 执行系统命令、查看数据库、植入后门

---

## 3. 常见绕过方式

| 绕过类型       | 示例                                         |
|----------------|----------------------------------------------|
| **双扩展名**    | `shell.php.jpg`，服务只检查 `.jpg`           |
| **大小写混淆**  | `shell.PHp`、`shell.pHp5`                    |
| **Content-Type** | 上传时伪造 `Content-Type: image/jpeg`       |
| **Magic Header 伪造** | 文件头部伪造为图片，如 `GIF89a`       |
| **拖拽上传绕过** | H5 拖拽上传绕过常规 form 表单检查            |
| **后缀空格填充** | `shell.php `（注意：某些系统会忽略空格）     |
| **黑名单绕过**  | 文件名使用不可见字符如 `%00` 截断            |

---

## 4. 常见攻击载荷（以 PHP 为例）

**一句话木马：**

```php
<?php @eval($_POST['pass']); ?>
```

---



## 5. 防御方法

### 5.1 严格校验文件类型

| 检查方式 | 描述 |
|----------|------|
| **扩展名白名单** | 仅允许 `.jpg`, `.png`, `.pdf` 等 |
| **MIME 类型校验** | 校验 `Content-Type`，如 `image/jpeg` |
| **Magic Number** | 判断文件真实类型头部，如 `FF D8 FF` 是 JPG |

### 5.2 拒绝执行型文件上传

- 文件名随机重命名，如 `uuid.jpg`
- 文件保存到 **非 Web 根目录**
- 或配置上传目录为静态资源目录，不允许 PHP 执行

```nginx
# Nginx 禁止执行 .php
location /uploads/ {
    location ~ \.php$ {
        deny all;
    }
}
```

### 5.3 配置文件权限

- 上传目录设置不可执行权限（如 Linux 下 `chmod -x`）
- 不允许用户控制文件路径（防止路径穿越）

### 5.4 加强前后端校验一致性

- 前端限制选择文件类型
- 后端必须再检查，不能只信任前端

---

## 6. 检测工具与方法

| 工具 | 用法 |
|------|------|
| **Burp Suite** | 拦截上传请求，篡改扩展名 / Content-Type |
| **AWVS** | 自动扫描上传点漏洞 |
| **fimap** | 自动识别文件包含/上传等漏洞点 |
| **手工测试** | 上传木马 + 抓包修改测试是否能成功执行 |

---


