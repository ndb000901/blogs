# 文件与目录

## 1.文件类型

在 Linux 中，文件类型可以通过 `ls -l` 命令查看，文件类型信息会显示在每个文件或目录的权限字符串的最前面。Linux 中常见的文件类型包括以下几种：

1. **普通文件（Regular file）**  
   - 符号：`-`
   - 描述：普通文件包含数据，可以是文本、图像、可执行程序等。
   - 示例：`-rw-r--r--`

2. **目录文件（Directory）**  
   - 符号：`d`
   - 描述：目录文件包含其他文件和目录，类似文件夹。
   - 示例：`drwxr-xr-x`

3. **符号链接（Symbolic link）**  
   - 符号：`l`
   - 描述：符号链接是指向另一个文件或目录的快捷方式。
   - 示例：`lrwxrwxrwx`

4. **字符设备文件（Character device）**  
   - 符号：`c`
   - 描述：字符设备文件提供与设备进行字符流交互的接口，例如终端设备。
   - 示例：`crw-rw-rw-`

5. **块设备文件（Block device）**  
   - 符号：`b`
   - 描述：块设备文件提供与设备进行块数据交互的接口，例如硬盘驱动器。
   - 示例：`brw-rw----`

6. **管道文件（Pipe，或称命名管道 FIFO）**  
   - 符号：`p`
   - 描述：用于进程间通信，允许数据流单向传递。
   - 示例：`prw-r--r--`

7. **套接字文件（Socket）**  
   - 符号：`s`
   - 描述：套接字文件用于网络通信或进程间通信。
   - 示例：`srwxr-xr-x`

在输出中，最左侧的第一个字符表示文件类型。

## 2.stat,fstat,fstatat,lstat

在 Linux 的 C 语言编程中，`stat` 是一个系统调用函数，用于获取文件的详细信息。
`stat` 函数可以获取文件的类型、大小、权限、时间戳等信息，这在文件操作和系统编程中非常有用。

### 函数声明

`stat` 和其相关函数在 `<sys/stat.h>` 头文件中声明：

```c
#include <sys/stat.h>
int stat(const char *pathname, struct stat *buf);
int lstat(const char *pathname, struct stat *buf);
int fstat(int fd, struct stat *buf);
int fstatat(int dirfd, const char *pathname, struct stat *statbuf, int flags);
```

- `stat`：获取文件的状态信息。
- `lstat`：获取符号链接本身的状态信息（而不是它指向的文件）。
- `fstat`：获取文件描述符 `fd` 指向的文件的状态信息。
- `fstatat`: 基于当前目录(drifd指向的目录)，获取文件统计信息。flag控制是否跟随符号链接文件。

### 参数

- `pathname`：要查询的文件路径。
- `fd`：文件描述符，用于 `fstat`。
- `buf`：指向 `stat` 结构体的指针，用于存储文件的状态信息。

### 返回值

- 成功时返回 `0`，并将文件状态信息存储在 `buf` 指向的 `stat` 结构体中。
- 失败时返回 `-1`，并设置 `errno` 以指示错误原因。

### `stat` 结构体

`stat` 结构体（定义在 `<sys/stat.h>` 中）包含文件的详细信息：

```c
struct stat {
    dev_t     st_dev;     /* 设备 ID */
    ino_t     st_ino;     /* inode 编号 */
    mode_t    st_mode;    /* 文件类型和权限 */
    nlink_t   st_nlink;   /* 硬链接数 */
    uid_t     st_uid;     /* 文件所有者的用户 ID */
    gid_t     st_gid;     /* 文件所有者的组 ID */
    dev_t     st_rdev;    /* 特殊设备 ID（若文件为特殊设备） */
    off_t     st_size;    /* 文件大小（字节） */
    blksize_t st_blksize; /* IO 块大小 */
    blkcnt_t  st_blocks;  /* 占用的块数 */
    time_t    st_atime;   /* 上次访问时间 */
    time_t    st_mtime;   /* 上次修改时间 */
    time_t    st_ctime;   /* 上次状态更改时间 */
};
```

### 注意事项

- **权限检查**：在使用 `stat` 系统调用之前，确保应用程序有权限访问该文件。
- **符号链接**：使用 `lstat` 可以避免符号链接被解引用而指向目标文件。

### 示例代码

```c
#include<sys/stat.h>
#include<stdio.h>

int main(int argc, char const *argv[])
{
    struct stat buf;
    int ret = stat("./stat-demo.c", &buf);

    printf("uid: %d\n", buf.st_uid);
    printf("gid: %d\n", buf.st_gid);
    printf("device number: %d\n", buf.st_dev);
    printf("i-node number: %d\n", buf.st_ino);
    printf("mode: %d\n", buf.st_mode);
    printf("number of links: %d\n", buf.st_nlink);
    printf("file size: %d\n", buf.st_size);
    printf("last access time: %d\n", buf.st_atime);
    printf("last modified time: %d\n", buf.st_mtime);
    printf("creation time: %d\n", buf.st_ctime);

    // 判断文件类型
    // 普通文件
    if (S_ISREG(buf.st_mode))
    {
        printf("regular file\n");
    }
    // 目录文件
    else if (S_ISDIR(buf.st_mode))
    {
        printf("directory file\n");
    }
    // 字符设备文件
    else if (S_ISCHR(buf.st_mode))
    {
        printf("character device file\n");
    }
    // 块设备文件
    else if (S_ISBLK(buf.st_mode))
    {
        printf("block device file\n");
    }
    // FIFO文件或管道
    else if (S_ISFIFO(buf.st_mode))
    {
        printf("fifo file\n");
    }
    // 符号链接文件
    else if (S_ISLNK(buf.st_mode))
    {
        printf("symbolic link file\n");
    }
    // socket文件
    else if (S_ISSOCK(buf.st_mode))
    {
        printf("socket file\n");
    }
    
    return 0;
}

```

### 输出

```shell
uid: 1000
gid: 1000
device number: 64768
i-node number: 13780838
mode: 33204
number of links: 1
file size: 1395
last access time: 1730476589
last modified time: 1730476589
creation time: 1730476589
regular file
```

## 3.umask

`umask`（用户文件创建掩码）是在 Unix 和 Linux 系统上用来设置新创建文件和目录的默认权限的命令。`umask` 决定了文件或目录的权限被移除的部分，表示哪些权限将不赋予新创建的文件或目录。

### 工作原理
- 系统默认的权限通常是：
  - 文件：`666`（即允许读写）
  - 目录：`777`（即允许读、写和执行）

- `umask` 值会从这些默认权限中移除指定的权限。例如，umask 设置为 `022` 时，系统会从默认权限中减去 `022`，这样新创建的文件权限将是 `644`（即 `666 - 022`），目录权限将是 `755`（即 `777 - 022`）。

## 3.设置用户id 和设置组id

在 Linux 中，设置用户 ID（UID）和组 ID（GID）可以通过文件的权限位来实现。这主要涉及 `setuid` 和 `setgid` 位，它们用于指定文件在执行时临时更改进程的有效 UID 或 GID，从而提升权限或访问权限更高的资源。以下是详细说明：

### `setuid`（设置用户 ID）

设置 `setuid` 位可以使文件在执行时拥有文件所有者的用户 ID，而不仅仅是执行该文件的用户的 ID。一般用于具有高权限的程序（如 `passwd`），使普通用户可以临时获得较高权限来执行特定任务。

- **设置 `setuid`**：
  ```bash
  chmod u+s filename
  ```
  - `u+s`：将 `setuid` 位设置给文件所有者。

- **识别 `setuid` 文件**：
  执行 `ls -l` 查看文件权限时，可以看到权限位中用户权限部分的 `s`（如 `-rwsr-xr-x`），表示 `setuid` 位已设置。

- **注意**：
  `setuid` 仅在文件是可执行文件时生效。

### `setgid`（设置组 ID）

设置 `setgid` 位可以使文件在执行时拥有文件所属组的组 ID。这在组共享文件夹或可执行文件时很有用，可以确保所有文件在同一组内共享权限。

- **设置 `setgid`**：
  ```bash
  chmod g+s filename
  ```
  - `g+s`：将 `setgid` 位设置给文件所属组。

- **识别 `setgid` 文件或目录**：
  在 `ls -l` 输出中可以看到权限位中组权限部分的 `s`（如 `-rwxr-sr-x`），表示 `setgid` 位已设置。

- **目录上的 `setgid`**：
  对于目录，`setgid` 位确保该目录内创建的文件或目录继承其所属组。

### 取消 `setuid` 和 `setgid`

- **取消 `setuid`**：
  ```bash
  chmod u-s filename
  ```
- **取消 `setgid`**：
  ```bash
  chmod g-s filename
  ```

### `setuid` 和 `setgid` 示例

#### 示例 1：给文件设置 `setuid`

```bash
# 创建一个可执行文件
touch testfile
chmod +x testfile

# 设置 setuid 位
chmod u+s testfile

# 查看权限
ls -l testfile
# 输出：-rwsr-xr-x  1 user group 0 Oct 31 10:00 testfile
```

#### 示例 2：给目录设置 `setgid`

```bash
# 创建一个目录
mkdir shared_dir

# 设置 setgid 位
chmod g+s shared_dir

# 查看权限
ls -ld shared_dir
# 输出：drwxr-sr-x  2 user group 4096 Oct 31 10:00 shared_dir
```

在 `shared_dir` 目录内创建的文件和目录将自动继承 `shared_dir` 的组 ID。

#### 示例3: passwd

```shell
# ls -l /usr/bin/passwd
-rwsr-xr-x 1 root root 59976 Feb  6  2024 /usr/bin/passwd

# ls -l /etc/passwd
-rw-r--r-- 1 root root 1833 Apr 21  2024 /etc/passwd

# 当用户执行passwd 命令时，启动的passwd进程的有效用户ID 被设置为passwd程序的文件拥有者

# sudo su
# chmod u-x /usr/bin/passwd
# ls -l /usr/bin/passwd
# 没有执行权限的标志为大写S
-rwSr-xr-x 1 root root 59976 Feb  6  2024 /usr/bin/passwd
```


## 4.文件访问权限

## 5.access, faccessat

## 6.chmod,fchmod,fchmodat

## 7.chown,fchown,fchownat,lchown

## 8.文件截断

## 9.文件长度

## 10.粘着位

## 11.link,linkat,unlink,unlinkat,remove

## 12.rename,renameat

## 13.符号链接

## 14.文件的时间

## 15.futimens,utimensat,utimes

## 16.mkdir,mkdirat,rmdir

## 17.读目录

## 18.chdir,fchdir,getcwd
