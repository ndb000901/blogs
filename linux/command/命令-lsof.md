# lsof 命令

`lsof`（List Open Files）是 Linux 和 Unix 系统中用于列出当前系统中打开的文件的命令。它可以查看与进程相关的文件、套接字、设备文件、网络连接等。通过 `lsof` 可以检查系统资源使用情况，排查文件和进程之间的关系。

---

## 1. 基本格式

```bash

lsof [选项]
```

---

## 2. 常用选项详解

### 2.1 `-i`：列出网络文件

```bash

lsof -i
```
- 显示所有打开的网络连接，包括 TCP、UDP 等协议。可以根据协议或端口进一步筛选。

---

### 2.2 `-t`：仅输出进程ID（PID）

```bash

lsof -t
```
- 只输出进程ID，可以与其他命令结合使用。例如，结合 `kill` 命令终止进程：

```bash

kill -9 $(lsof -t -i:8080)
```

---

### 2.3 `-u`：按用户筛选

```bash

lsof -u username
```
- 显示指定用户打开的所有文件。

---

### 2.4 `-c`：按进程名筛选

```bash

lsof -c process_name
```
- 显示由指定进程名（如 `nginx`、`sshd`）打开的文件。

---

### 2.5 `-p`：按进程ID筛选

```bash

lsof -p PID
```
- 显示指定进程ID（PID）打开的文件。

---

### 2.6 `-n`：显示IP地址而不是域名

```bash

lsof -i -n
```
- 禁止 DNS 解析，直接显示 IP 地址而不是主机名。常用来提高查询速度。

---

### 2.7 `-t` + `-i`：仅列出使用某个端口的进程

```bash

lsof -t -i :80
```
- 显示所有占用端口 80 的进程ID。

---

### 2.8 `+D`：递归显示指定目录中的文件

```bash

lsof +D /path/to/directory
```
- 显示指定目录及其子目录中所有打开的文件。

---

### 2.9 `-d`：按文件描述符筛选

```bash

lsof -d 3
```
- 显示所有使用指定文件描述符（如 3）的进程。

---

### 2.10 `+L`：显示删除但仍被占用的文件

```bash

lsof +L1
```
- 列出那些已删除但仍被进程占用的文件，通常用于排查“文件占用”问题。

---

### 2.11 `-F`：自定义输出格式

```bash

lsof -F
```
- 输出简洁的格式，只显示文件的标识符，适合脚本处理。

---

## 3. 高阶选项与组合用法

### 3.1 查找占用端口的进程

```bash

lsof -i :8080
```
- 查找所有使用端口 8080 的进程。

### 3.2 查找占用某个文件的进程

```bash

lsof /path/to/file
```
- 查找占用指定文件的进程。

### 3.3 查找某个用户打开的文件

```bash

lsof -u username
```
- 查找指定用户打开的文件。

### 3.4 查找特定进程打开的文件

```bash

lsof -p <PID>
```
- 查找指定进程（PID）打开的文件。

### 3.5 查看所有网络连接及其状态

```bash

lsof -i
```
- 显示系统中所有的网络连接，包括端口、协议、连接状态等。

---

## 4. 输出字段说明（示例）

```bash

COMMAND   PID  USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
sshd      1234 root  cwd    DIR  253,1     4096  512 /home/user
sshd      1234 root  txt    REG  253,1    1500   516 /usr/sbin/sshd
sshd      1234 root  mem    REG  253,1    2048   520 /lib/x86_64-linux-gnu/libc.so.6
```

- **COMMAND**：进程名称。
- **PID**：进程ID。
- **USER**：进程所属用户。
- **FD**：文件描述符（如 cwd 为当前工作目录）。
- **TYPE**：文件类型（DIR、REG、FIFO 等）。
- **DEVICE**：设备号。
- **SIZE/OFF**：文件大小或偏移量。
- **NODE**：文件的 inode。
- **NAME**：文件的路径或名称。

---

## 5. 使用 `lsof` 排查常见问题

### 5.1 排查端口占用

```bash

lsof -i :8080
```
- 查看端口 8080 被哪个进程占用。

### 5.2 排查文件被占用问题

```bash

lsof /path/to/file
```
- 查看某个文件是否被占用，哪个进程在使用它。

---


