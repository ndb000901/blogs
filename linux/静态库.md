# 静态库

静态库（Static Library）是一种将代码预编译为可重用的目标文件的库。在构建应用程序时，静态库的内容被直接复制到可执行文件中，因此最终生成的程序无需在运行时依赖外部库文件。静态库的主要特点是代码在编译时被直接链接进应用程序，程序可以独立运行。

### 静态库的特点
1. **文件扩展名**：静态库在 Linux 系统中通常使用 `.a` 后缀，在 Windows 系统中使用 `.lib` 后缀。
2. **编译时链接**：静态库在编译阶段被链接到目标程序，编译器将需要的库代码直接打包到可执行文件中。
3. **独立性**：程序运行时不依赖于外部的库文件，便于分发和部署。
4. **占用空间**：由于每个使用静态库的可执行文件都包含了库的代码，程序体积较大。
5. **更新不便**：如果静态库更新，所有使用该库的应用程序都需要重新编译。

### 创建和使用静态库
以下是如何在 Linux 系统上创建和使用静态库的示例。

#### 1. 创建静态库
假设我们有两个源文件 `math1.c` 和 `math2.c`，分别包含一些数学函数：

```c
// math1.c
int add(int a, int b) {
    return a + b;
}

// math2.c
int multiply(int a, int b) {
    return a * b;
}
```

**步骤1：编译源文件**
首先将源文件编译为目标文件（`.o` 文件）：

```bash
gcc -c math1.c -o math1.o
gcc -c math2.c -o math2.o
```

**步骤2：创建静态库**
使用 `ar` 命令将目标文件打包为静态库文件 `libmath.a`：

```bash
ar rcs libmath.a math1.o math2.o
```

在这条命令中：
- `r` 表示将目标文件添加到库中。
- `c` 表示创建库。
- `s` 表示创建索引，加快链接速度。

生成的 `libmath.a` 文件就是静态库文件。

#### 2. 使用静态库
编写一个使用静态库的应用程序 `main.c`：

```c
#include <stdio.h>

int add(int a, int b);
int multiply(int a, int b);

int main() {
    printf("3 + 4 = %d\n", add(3, 4));
    printf("3 * 4 = %d\n", multiply(3, 4));
    return 0;
}
```

编译时，链接静态库 `libmath.a`：

```bash
gcc main.c -L. -lmath -o main
```

在这里：
- `-L.` 表示库文件的路径在当前目录。
- `-lmath` 表示链接 `libmath.a` 静态库（去掉前缀 `lib` 和后缀 `.a`）。

#### 3. 运行程序
执行生成的可执行文件 `main`，观察输出结果：

```bash
./main
```

### 静态库的优缺点
#### 优点
- **独立性**：可执行文件不依赖外部库，易于分发和安装。
- **加载速度快**：因为不需要在运行时加载库文件。
- **可靠性高**：由于库被直接嵌入可执行文件，版本管理简单，避免了动态库的兼容性问题。

#### 缺点
- **体积较大**：静态库代码被嵌入到每一个使用它的可执行文件中，会增加程序的体积。
- **更新不便**：若库代码发生变化，所有使用该库的可执行文件都需要重新编译。
- **内存占用高**：同一静态库的代码在多个程序中重复加载，占用更多内存。

### 静态库与动态库的对比
| 特性               | 静态库                         | 动态库                           |
|--------------------|--------------------------------|----------------------------------|
| 链接方式           | 编译时链接                     | 运行时链接                       |
| 文件扩展名         | `.a`（Linux）、`.lib`（Windows）| `.so`（Linux）、`.dll`（Windows）|
| 可执行文件体积     | 较大                           | 较小                             |
| 内存使用           | 多个程序独立加载，占用较多内存 | 多个程序共享，占用较少内存       |
| 更新方便性         | 更新库需重新编译               | 可以直接替换动态库文件           |
| 程序加载速度       | 较快                           | 较慢（需要动态加载）             |

### 总结
静态库适合在系统资源较多、程序更新不频繁的环境中使用，常用于嵌入式设备、实时系统、独立发行的软件等。而在需要频繁更新、节省存储空间的场合，动态库更为合适。