# TCP协议基础

## 资料

- [wireshark下载](https://www.wireshark.org/download.html)
- [数据包下载](./packet/tcp-demo.pcapng) 
- `packet/tcp-demo.pcapng` 使用wireshark 打开

## 1. TCP协议头详解

```text

  0                   1                   2                   3  
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1  
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |          Source Port          |       Destination Port        |  (0-3)
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        Sequence Number                        |  (4-7)
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                    Acknowledgment Number                      |  (8-11)
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |  Data |Rese-|  Control Flags |                               |
 | Offset|rved |  (NS,CWR,ECE,  |       Window Size             | (12-13)
 |  (4b) | (3b) |  URG,ACK,PSH,  |                               | (14-15)
 |       |      |  RST,SYN,FIN) |                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |       Checksum                |    Urgent Pointer (if URG)    | (16-19)
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |               Options (0~40 bytes, optional)                  |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                         Padding (if needed)                   |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

```

### 1.1 TCP头部结构

| 字段名                     | 长度（位） | 说明 |
|--------------------------|------------|------|
| 源端口号（Source Port）   | 16         | 源主机端口号 |
| 目标端口号（Dest Port）   | 16         | 目的主机端口号 |
| 序号（Sequence Number）   | 32         | 本报文段发送的数据的起始序号 |
| 确认号（Ack Number）      | 32         | 期望接收的数据的下一个序号 |
| 数据偏移（Header Length） | 4          | TCP头部长度（单位为4字节） |
| 保留（Reserved）          | 3          | 保留位 |
| 控制位（Flags）           | 9          | 控制标志：URG, ACK, PSH, RST, SYN, FIN |
| 窗口大小（Window）        | 16         | 通知对方可接收的窗口大小（流量控制） |
| 校验和（Checksum）        | 16         | 整个TCP报文段的校验和 |
| 紧急指针（Urgent Pointer）| 16         | URG标志为1时有效 |
| 可选字段（Options）       | 可变       | 常用于握手期间的MSS、窗口扩大等 |


- **序列号（Sequence Number）**
    - 表示当前报文段数据的第一个字节的编号。
    - 用于数据的顺序和重传。

- **确认号（Acknowledgment Number）**
    - 表示期望收到对方下一个字节的序号，即：已成功收到对方至序号N-1的数据。

- **控制位（Flags）** 常见的控制位如下：

| 标志位 | 含义         | 作用说明         |
|--------|--------------|--------------|
| URG    | 紧急         | 紧急数据处理（几乎不用） |
| ACK    | 确认         | Ack号字段是否有效   |
| PSH    | 推送         | 强制接收方立即处理，立刻将收到的数据“推”给应用层，而不是先缓冲起来  |
| RST    | 重置连接     | 异常断开连接       |
| SYN    | 同步         | 建立连接请求       |
| FIN    | 结束         | 表示发送方数据发送完毕  |

---

### 1.2 可选字段

| Kind | 名称            | 长度 | 说明                                     |
|------|-----------------|------|------------------------------------------|
| 0    | EOL             | 1    | 结束选项列表                             |
| 1    | NOP             | 1    | 填充 / 对齐用途                          |
| 2    | MSS             | 4    | 最大段大小，SYN中使用                    |
| 3    | Window Scale    | 3    | 窗口扩大，SYN中使用                      |
| 4    | SACK Permitted  | 2    | 允许 SACK，仅用于 SYN                    |
| 5    | SACK            | 可变 | SACK块（最多4个），非SYN中使用           |
| 8    | Timestamp       | 10   | 时间戳，常用于RTT估计和PAWS              |

TCP 头部的 Options 是一个**可变长字段**，放在 TCP 头部最后，最长可以达到 **40 字节**（因为 TCP 头最长 60 字节，固定头部 20 字节）。

每个 Option 均以如下格式出现：

| 字节序 | 含义         |
|--------|--------------|
| 1 byte | **Kind**     |
| 1 byte | **Length**（含Kind+Length+Value） |
| n byte | **Value**    |

> 特例：Kind = 0（EOL） 和 Kind = 1（NOP）没有 Length 和 Value 字段。

---

#### 1.2.1 **EOL (End of Option List)**
- **Kind = 0**
- **长度 = 1 字节**
- **作用**：标记 Options 结束，后续字节无效
- 常见于 Option 末尾，便于解析器快速停止

---

#### 1.2.2 **NOP (No Operation)**
- **Kind = 1**
- **长度 = 1 字节**
- **作用**：用于对齐，保证下一个 Option 从 4 字节边界开始
- 常用于 Timestamp 和 SACK 等需对齐的字段前

---

#### 1.2.3 **MSS (Maximum Segment Size)**
- **Kind = 2**
- **Length = 4**
- **Value = 2 字节（最大 segment payload 大小）**
- **用途**：告诉对方：我最大能收的数据负载是 X 字节
- **仅出现在 SYN 报文中**
- 例子：
  ```hex
  02 04 05 B4
  ```
  表示 MSS = 0x05B4 = 1460（常见于 MTU = 1500 的网络）

---

#### 1.2.4 **Window Scale**
- **Kind = 3**
- **Length = 3**
- **Value = 1 字节（Shift count）**
- **作用**：扩大接收窗口字段（16-bit 太小）
- 接收窗口 = 原始窗口字段值 × 2^ShiftCount
- **仅在 SYN 阶段协商**
- 例子：
  ```hex
  03 03 07
  ```
  表示窗口扩大 2^7 = 128 倍

---

#### 1.2.5 **SACK Permitted**
- **Kind = 4**
- **Length = 2**
- **Value = 无**
- **作用**：声明本端支持 Selective ACK
- **仅在 SYN 报文中使用**
- 配合 Kind=5 的 SACK 使用
- 示例：
  ```hex
  04 02
  ```

---

#### 1.2.6 **SACK (Selective Acknowledgment)**
- **Kind = 5**
- **Length = N（>2，可变）**
- **Value = 每块8字节，包含 left/right 边界**
- **作用**：告诉对方哪些段我已收到，避免重传整个窗口
- 最多支持 4 个 SACK 块（32 字节）
- **只有当对方允许（Kind=4）后才能使用**

- 示例（收到 1000–2000 和 3000–4000 的数据）：
  ```hex
  05 0A 00 00 03 E8 00 00 07 D0
  ```
  即：
    - 0x03E8 = 1000
    - 0x07D0 = 2000

---

#### 1.2.7 **Timestamp**
- **Kind = 8**
- **Length = 10**
- **Value = 两个4字节字段**
    - TSval：当前时间戳（用于 RTT）
    - TSecr：对方上次发来的 TSval（用于计算 RTT）
- **用途**：
    - 精确估算 RTT
    - PAWS（保护机制）：防止旧包污染连接
- 通常配合 Window Scale 一起使用

- 示例：
  ```hex
  08 0A 00 12 34 56 00 78 9A BC
  ```
  表示：
    - TSval = 0x00123456
    - TSecr = 0x00789ABC

---

### 1.3 Options 排列原则

- 可选字段总长度必须是 4 字节对齐的（TCP头部必须是 32-bit 对齐）
- 所以需要使用 NOP 来填充空隙
- 顺序通常是：
  ```
  MSS → Window Scale → SACK Permitted → Timestamps → NOP → SACK
  ```

---


## 2. TCP三次握手过程

三次握手的目的是：**建立可靠的连接、协商序号、初始化双方状态**

### 第一次握手：客户端发送SYN

| 字段名   | 值                |
|----------|-------------------|
| SYN      | 1                 |
| SEQ      | x（客户端初始序号） |
| ACK      | 无（ACK位 = 0）    |

客户端进入 **SYN_SEND** 状态。

---

### 第二次握手：服务端发送 SYN+ACK

| 字段名   | 值                         |
|----------|----------------------------|
| SYN      | 1                          |
| ACK      | 1                          |
| SEQ      | y（服务端初始序号）        |
| ACK_NUM  | x+1（确认客户端SYN）        |

服务端进入 **SYN_RECEIVED** 状态。

---

### 第三次握手：客户端发送 ACK

| 字段名   | 值                 |
|----------|--------------------|
| SYN      | 0（不再设置）      |
| ACK      | 1                  |
| SEQ      | x+1                |
| ACK_NUM  | y+1                |

客户端进入 **ESTABLISHED** 状态，服务端收到ACK后也进入 **ESTABLISHED**。

---

### 连接建立完成，双方可以开始传输数据

在三次握手中，**TCP头部的关键字段变化如下：**

| 步骤 | SYN | ACK | SEQ    | ACK_NUM |
|------|-----|-----|--------|---------|
| 1    | 1   | 0   | x      | 无       |
| 2    | 1   | 1   | y      | x+1     |
| 3    | 0   | 1   | x+1    | y+1     |

---



## 3. TCP 四次挥手

四次挥手的作用是：**可靠地关闭连接，保证数据完整传输**。其过程由主动关闭方和被动关闭方完成。


- TCP 是 **全双工** 的，即双方都必须分别关闭自己的发送方向。
- 所以需要 **两对 FIN/ACK**，共四次报文交换。

---

### 第一次挥手：主动关闭方发送 FIN

| 字段        | 值                |
|-------------|-------------------|
| FIN         | 1                 |
| ACK         | 1                 |
| SEQ         | x                 |
| ACK_NUM     | y（之前已确认）   |

- 表示：**我没数据可发了，但你可以继续发给我**
- 发送完后，进入状态：`FIN_WAIT_1`

---

### 第二次挥手：被动方确认 ACK

| 字段        | 值                |
|-------------|-------------------|
| FIN         | 0                 |
| ACK         | 1                 |
| SEQ         | y                 |
| ACK_NUM     | x+1               |

- 发送完后，被动方状态为：`CLOSE_WAIT`（等待自己程序关闭）
- 主动方状态变为：`FIN_WAIT_2`

---

### 第三次挥手：被动关闭方发送 FIN

| 字段        | 值                |
|-------------|-------------------|
| FIN         | 1                 |
| ACK         | 1                 |
| SEQ         | y+z               |
| ACK_NUM     | x+1               |

- 表示：**我也没数据发了**
- 进入状态：`LAST_ACK`

---

### 第四次挥手：主动方确认 ACK

| 字段        | 值                |
|-------------|-------------------|
| FIN         | 0                 |
| ACK         | 1                 |
| SEQ         | x+1               |
| ACK_NUM     | y+z+1             |

- 主动关闭方进入 `TIME_WAIT` 状态，等待 2MSL（最长报文寿命 * 2）
- 被动关闭方进入 `CLOSED`，连接彻底关闭。

---

### TIME_WAIT 的必要性

1. 确保对方能接收到我们的 ACK（如果丢了，对方会重发 FIN）
2. 防止旧连接的数据混入新连接（MSL后包都会过期）

---



