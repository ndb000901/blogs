# 以太网帧


数据链路层的主要任务是将网络层（IP层）的数据封装成 **数据帧**，以便在物理网络上传输。不同的物理介质和协议可能有不同的数据帧格式，但常见的**以太网（Ethernet）帧格式**是我们最常讨论的。

## 资料

- [wireshark下载](https://www.wireshark.org/download.html)
- [数据包下载](./packet/ethernet-demo.pcapng)
- `packet/ethernet-demo.pcapng` 使用wireshark 打开

## 1. **以太网数据帧** 格式（Ethernet Frame）

以太网帧的结构可以分为几个固定和可变长度的字段。以下是一个标准的以太网帧结构：

```
+------------------+---------------------+------------------------+
| 目标 MAC 地址    | 源 MAC 地址         | 类型/长度               |
| (6 字节)         | (6 字节)            | (2 字节)                |
+------------------+---------------------+------------------------+
| 数据 (46-1500 字节)                                               |
+------------------+--------------------------------------------------------+
| CRC 校验 (4 字节)                                                |
+---------------------------------------------------------------+
```

---

### 各字段详细解析

1. **目标 MAC 地址 (6 字节)**  
   目标设备的物理地址（MAC 地址）。它告诉帧应该传送给网络中哪个设备。如果目标是广播地址，则是全 F（FF:FF:FF:FF:FF:FF）。

2. **源 MAC 地址 (6 字节)**  
   发送设备的物理地址（MAC 地址）。每个网卡都有唯一的 MAC 地址，帧通过源 MAC 地址标识发送者。

3. **类型/长度字段 (2 字节)**
    - **类型**：用于标识上层协议。例如，0x0800 表示 IP 协议，0x0806 表示 ARP 协议。
    - **长度**：如果值小于 0x0600（1536），则表示数据字段的长度（单位字节）。否则，表示数据上层协议的类型。

4. **数据字段 (46 - 1500 字节)**
    - 包含 **网络层的数据**（例如，IP 数据包）。
    - **最小长度为 46 字节**，如果数据小于 46 字节，需要填充（Padding），确保帧的最小长度为 64 字节。
    - **最大长度为 1500 字节**，超过这个长度的帧需要被分片。

5. **CRC 校验 (4 字节)**
    - 帧尾的 4 字节用于 **循环冗余校验（CRC）**，它用来检测帧在传输过程中是否发生了错误。接收端会重新计算校验值，判断数据是否损坏。

---

### 常见的以太网帧类型（Type 字段）

| 类型值   | 协议           |
|----------|----------------|
| 0x0800   | IPv4           |
| 0x0806   | ARP            |
| 0x86DD   | IPv6           |
| 0x8847   | MPLS (Multiprotocol Label Switching) |
| 0x8848   | MPLS-MC        |


## 2. 以太网帧的详细工作过程

1. **封装过程**：
    - 网络层（如 IP 协议）提供数据后，数据链路层会将其封装成一个数据帧。
    - 加入目标和源的 MAC 地址，确定目标设备。
    - 数据长度或类型信息指示上层协议类型或数据长度。
    - 数据部分携带传输的 IP 数据包等。
    - 在帧尾添加 CRC 校验和，以便在传输中进行错误检查。

2. **错误检测**：
    - 接收方会计算数据帧的 CRC 校验和，并与帧内的 CRC 校验和进行对比。如果一致，说明数据没有错误；如果不一致，数据就被认为是损坏的，需要请求重新发送。

---


---

## 3. 以太网帧和 IP 数据包的关系

1. **物理层**：以太网帧作为数据链路层的封装单位，负责在物理介质上传输数据。
2. **数据链路层**：以太网帧的最大负载通常为 1500 字节（MTU）。当数据超过这个大小时，会被分割成多个以太网帧。
3. **网络层**：以太网帧内部会封装一个完整的 IP 数据包（无论是 IPv4 还是 IPv6），网络层负责数据的路由与转发。

---
