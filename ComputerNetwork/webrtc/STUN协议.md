# STUN 协议

STUN（Session Traversal Utilities for NAT）是一个非常重要的协议，在 WebRTC、VoIP 和其他实时通信中扮演“**协助 NAT 穿透**”的角色。它定义在 [RFC 5389](https://datatracker.ietf.org/doc/html/rfc5389) 中。

---

## 1. STUN 的基本作用

**STUN 的核心用途：**

> 让 NAT 后的客户端知道：
> - 自己在公网的 IP 和端口（即 NAT 映射地址）
> - NAT 类型是否支持 UDP 通信

STUN 是一种 “轻量级” 服务器辅助方式 —— 不中转数据，仅用于**连接建立前的信息探测**。

---

## 2. STUN 的工作流程

以 WebRTC 为例：

1. **Client 向 STUN Server 发起请求**（UDP）；
2. Server 查看 IP 包头信息，并返回：
    - 你**外部的 IP 和端口**；
    - 此信息被称为 **Server Reflexive Address（srflx）**；
3. 客户端将 srflx 地址放入 SDP 的 candidate 中发送给对方；
4. 双方通过 ICE 协议尝试连接这些地址（host/srflx/relay）；

### 示例流程图：

```
[Client: 192.168.1.10]   --> Binding Request -->   [STUN Server]
                                          <-- Binding Response (1.2.3.4:57336)
```

---

## 3. STUN 消息格式详解

每个 STUN 消息由 **消息头 + 属性列表（attribute）** 组成：

### 消息头（20 字节）

```text

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|0 0|     STUN Message Type     |         Message Length        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         Magic Cookie                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
|                     Transaction ID (96 bits)                  |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                             Data                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

| 字段        | 长度   | 描述                        |
|-------------|--------|-----------------------------|
| Type        | 2 字节 | 消息类型，如 BindingRequest |
| Length      | 2 字节 | 属性总长度（不含头部）       |
| Magic Cookie| 4 字节 | 固定为 `0x2112A442`         |
| Transaction ID | 12 字节 | 随机生成，用于响应匹配   |

### 常见消息类型

| Type (16位)    | 含义                        |
|----------------|-----------------------------|
| 0x0001         | Binding Request              |
| 0x0101         | Binding Response             |
| 0x0111         | Binding Error Response       |

### 典型属性（Attribute）

```text
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Type                  |            Length             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         Value (variable)                ....
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

| 属性名                | 类型值 | 含义                           |
|------------------------|--------|--------------------------------|
| `MAPPED-ADDRESS`       | 0x0001 | 老版本，反射地址（弃用）        |
| `XOR-MAPPED-ADDRESS`   | 0x0020 | 推荐使用的反射地址（RFC 5389） |
| `USERNAME`             | 0x0006 | 认证用用户名                   |
| `MESSAGE-INTEGRITY`    | 0x0008 | HMAC-SHA1 校验                 |
| `FINGERPRINT`          | 0x8028 | CRC 校验                       |

---

### XOR-MAPPED-ADDRESS

为了防止中间人修改数据，RFC 5389 推荐用 **XOR 方式编码的地址**，防止被 NAT 检测。

```bash

IP XOR MagicCookie（0x2112A442）
PORT XOR 高 16 位 MagicCookie
```

客户端解码时会将其还原出真实公网 IP 和端口。

---


