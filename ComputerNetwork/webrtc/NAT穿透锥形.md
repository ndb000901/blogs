# NAT穿透锥形

NAT（网络地址转换）穿透中的“锥形”（Cone）是描述 NAT 行为的一种分类方式，尤其是在研究 **NAT 穿透（NAT Traversal）**时非常重要，比如在 WebRTC、VoIP 等 P2P 通信中。

下面是标准的 NAT 锥形类型，共有 4 种类型，越靠后越难打洞：

---

## 1. **Full Cone NAT**（完全锥形 NAT）

```text

         内网端口
             |
             |
           ┌─┼─┐        ← 全部外部地址都能访问
         ┌─┘   └─┐      ← 任意IP:任意端口都能打进来
     外部IP1     外部IP2

```

### 特点：
- 一个内部 IP:Port 映射到一个公网 IP:Port。
- **任何外部地址**只要发送数据到这个公网 IP:Port，**都能打进来**（只要这个映射存在）。

### 行为示例：
- 内部 `192.168.1.10:1234` → 公网 `1.2.3.4:5678`
- 外部任意地址，只要发包到 `1.2.3.4:5678`，都能进来。

**最容易打洞**，UDP P2P 友好。

---

## 2. **Restricted Cone NAT**（受限锥形 NAT）

```text

         内网端口
             |
             |
           ┌─┼─┐
         ┌─┘   └────┐     ← 只有你“发过包”的IP才可进来
     外部IP1       外部IP2 ❌

```

### 特点：
- 内网发送数据给某个外部 IP 后，**只有该 IP（任意端口）**可以回包。
- 如果未曾向外部某 IP 发包，NAT 会丢弃该 IP 发来的数据。

### 行为示例：
- 发过数据给 `8.8.8.8:any`，那么 `8.8.8.8:any` 回包可以进来。
- 但 `9.9.9.9:any` 发数据就进不来（未发起过）。

仍然 **可以打洞**，但需要双方先发包。

---

## 3. **Port Restricted Cone NAT**（端口受限锥形 NAT）

```text

         内网端口
             |
             |
           ┌─┼─┐
         ┌─┘   └─┐
  外部IP1:PortA   外部IP1:PortB ❌

```

### 特点：
- 内网发数据给外部某 IP:Port 后，**只有该 IP:Port 对**可以回包。
- 换端口也不行，防御更严。

### 行为示例：
- 发包到 `8.8.8.8:53` 后，只有 `8.8.8.8:53` 可以回包。
- `8.8.8.8:54` 或 `8.8.4.4:53` 都无法通过。

打洞成功率降低，但使用 **STUN + ICE 协商** 仍可能成功。

---

## 4. **Symmetric NAT**（对称 NAT）

```text

  内网端口:1234
     |        \
     |         \
公网映射1        公网映射2
(1.1.1.1:40000)   (2.2.2.2:40001)
     ↑                 ↑
  仅目标1可进      仅目标2可进

```

### 特点：
- 内网同一个 IP:Port 向不同的目标地址发送时，**每个目标都会分配不同的公网端口映射**。
- 且 **只有对应目标地址的回包能进来**。
- **对每个 (destination IP:port) 都重新映射**。

### 行为示例：
```text
192.168.1.10:1234 → 1.1.1.1:80 → 映射成 100.1.1.1:40000
192.168.1.10:1234 → 2.2.2.2:80 → 映射成 100.1.1.1:40001
```

只有 `1.1.1.1:80` 能回 `40000`，`2.2.2.2:80` 回不了。

**最难穿透**，打洞失败率最高。

通常需要 **TURN 中继服务器**绕过。

---

## 5. 对比

| 类型 | 描述 | 是否可穿透（P2P） |
|------|------|--------------|
| Full Cone | 所有人都能进 | 最容易 |
| Restricted Cone | 发过 IP 才能进 | 一般能打 |
| Port Restricted Cone | 发过 IP+Port 才能进 | 略难 |
| Symmetric | 每个目标映射不同 | 几乎无法打洞（需 TURN） |

---

