# 网络地址转换 NAT

## 1. NAT

**NAT（网络地址转换）** 是一种在局域网（LAN）和广域网（Internet）之间转换 IP 地址的机制。它的主要作用是：

- 让多个局域网设备共享一个公网 IP 上网；
- 隐藏内网结构，提高安全性。

举例说明：

你家里的电脑是 `192.168.1.100`，连的路由器公网 IP 是 `203.0.113.5`。你访问一个网站时，对方只看到来自 `203.0.113.5` 的请求，不知道你的内网 IP。

---

## 2. 映射创建类型



当一个内网主机（比如 `192.168.1.100:12345`）访问外网时，NAT 设备（如家用路由器）会为其分配一个公网 IP+端口，比如 `203.0.113.10:40000`。

问题在于：

> **这个公网端口是固定的吗？不同目标地址是否会创建不同映射？**

答案取决于 NAT 的 **映射行为类型**。

---

### 2.1 NAT 映射类型分类（RFC 4787）

| 类型 | 描述 | 是否可预测 | WebRTC 穿透性 |
|------|------|------|-----------|
| **Endpoint-Independent Mapping (EIM)** | 无论访问哪个公网 IP，都使用相同的公网映射端口 | 稳定映射 | 容易穿透 |
| **Address-Dependent Mapping (ADM)** | 不同目标公网 IP，会分配不同的端口 | 半可预测 | 中等难度 |
| **Address and Port Dependent Mapping (APDM)** | 每个目标 IP+端口，都创建不同映射 | 不可预测 | 非常难穿透（对称型 NAT） |

---

### 2.2 举例说明：

假设内网主机：`192.168.1.100:12345`，下面是它对外发送 UDP 包的情况：

#### Endpoint-Independent Mapping (EIM)
```text
发送到：8.8.8.8:53  → 公网映射：203.0.113.10:40000
发送到：1.1.1.1:123 → 公网映射：203.0.113.10:40000 相同端口！
```

#### Address-Dependent Mapping (ADM)
```text
发送到：8.8.8.8:53  → 映射：203.0.113.10:40000
发送到：1.1.1.1:123 → 映射：203.0.113.10:40001 IP 不同，端口不同
```

#### Address and Port Dependent Mapping (APDM)
```text
发送到：8.8.8.8:53  → 映射：203.0.113.10:40000
发送到：8.8.8.8:80  → 映射：203.0.113.10:40001 IP 相同但端口不同，也创建新映射
```

---


WebRTC 使用 STUN 来获取公网映射地址，但如果 NAT 类型是 **APDM**：

- 对 STUN 服务器生成的映射无法用于和 Peer 进行通信；
- 对端发包时 NAT 不认；
- 穿透失败，只能依赖 TURN 中继。

所以，**EIM 是最理想的 NAT 类型**，而 APDM（对称 NAT）是最差的，WebRTC 无法直接穿透。

---


## 3. 映射过滤类型

NAT 不仅决定如何为内网地址做映射（Mapping），它还决定：

> **允许哪些外部主机向这个映射地址（公网 IP+端口）发包？**

这就叫 **过滤行为（Filtering Behavior）**，或者说是“入口防火墙策略”。

---

### 3.1 主要过滤类型（RFC 4787）

| 类型 | 描述 | 外部访问限制 | 穿透难度  | 示例 |
|------|------|----------------|-------|------|
| **Endpoint-Independent Filtering（EIF）** | 任何外部主机都可以向映射地址发包 | 无限制 | 最容易穿透 | 常见于家用路由器 |
| **Address-Dependent Filtering（ADF）** | 仅允许**曾访问过的 IP** 发包 | 限制 IP | 中等    | 多数 NAT |
| **Address and Port Dependent Filtering（APDF）** | 仅允许**曾访问过的 IP+端口** 发包 | 限制 IP 和端口 | 非常难   | 企业/移动网络 |

---

### 3.2 举例

假设：内网主机 `192.168.1.100:54321` 发送数据到 `8.8.8.8:53`，NAT 映射为公网 `203.0.113.5:40000`。

接下来，另一个服务器 `1.1.1.1:9999` 想发 UDP 包到 `203.0.113.5:40000`，会不会被 NAT 拒绝？

- **EIF**：会接收（不限制谁发来）
- **ADF**：不会接收（没发过包给 1.1.1.1）
- **APDF**：也不会接收（IP 和端口都没对应）

---

WebRTC 是 **P2P 通信**，关键在于：

- 建立连接后，对端是否能向你打洞发包？
- 如果 NAT 过滤行为太严格，即便你知道对方公网地址，也没用。

WebRTC 的 `ICE` 会尝试以下流程：

1. 自己发包 → 获取公网映射；
2. 将该地址告诉对方；
3. 对方尝试向你发包 → **是否能进来取决于 Filtering Behavior**。







