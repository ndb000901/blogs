# UDP 协议

**UDP（User Datagram Protocol）** 是一种面向无连接的传输层协议，通常用于需要快速传输数据而不要求保证可靠性、顺序性和数据完整性的场景。UDP 相比于 TCP 更加轻量级，因为它不执行复杂的连接管理、流量控制、拥塞控制等机制。

## 资料

- [wireshark下载](https://www.wireshark.org/download.html)
- [数据包下载](./packet/udp-demo.pcapng)
- `packet/udp-demo.pcapng` 使用wireshark 打开

## 1. **UDP 协议的特点**

- **无连接**：UDP 是一种面向无连接的协议，发送数据前不需要建立连接。
- **不可靠**：UDP 不保证数据包的可靠送达，发送的消息可能丢失或乱序到达。
- **速度快**：因为没有连接建立和维护的开销，所以 UDP 的传输速度比 TCP 快。
- **支持广播和多播**：UDP 可以支持广播（向网络中所有主机发送数据）和多播（向指定的一组主机发送数据）。
- **数据报**：每个 UDP 数据包（或称为数据报）是独立的，发送和接收方之间没有持续的会话。

## 2. **UDP 数据报格式**

UDP 数据报（Datagram）的结构相对简单，由以下几个部分组成：

```text

+---------------------+-------------------+-----------------+-------------------+
|   Source Port (16)  | Destination Port (16) | Length (16)  | Checksum (16)      |
+---------------------+-------------------+-----------------+-------------------+
|                                                    Data (Variable Length)                                 |
+-----------------------------------------------------+--------------------------------------------------------+

```

| **字段**        | **长度** | **说明**                                |
|-----------------|----------|-----------------------------------------|
| 源端口（Source Port） | 16 位   | 发送方的端口号（可选）。如果为 0，则不使用。 |
| 目标端口（Destination Port） | 16 位   | 接收方的端口号。                        |
| 长度（Length）   | 16 位   | UDP 数据报的总长度（包括 UDP 头和数据）。 |
| 校验和（Checksum） | 16 位   | 用于错误检测，确保数据完整性。         |
| 数据（Data）     | 可变    | 实际传输的应用数据。                    |

## 3. **字段详解**

### **源端口（Source Port）**
- **大小**：16 位（2 字节）
- **用途**：标识发送端的端口号。此字段是可选的，若不需要则设置为 0。

### **目标端口（Destination Port）**
- **大小**：16 位（2 字节）
- **用途**：标识接收端的端口号。每个应用程序通常通过特定的端口号来接收数据。例如，DNS 服务使用 53 端口，HTTP 使用 80 端口。

### **长度（Length）**
- **大小**：16 位（2 字节）
- **用途**：UDP 数据报的总长度，包括头部（8 字节）和数据部分。最大值为 65535 字节。

### **校验和（Checksum）**
- **大小**：16 位（2 字节）
- **用途**：用于检验 UDP 数据报在传输过程中的完整性，确保数据未被损坏。即使在 IPv4 中该字段是可选的，但为了保证数据可靠性，通常还是会使用校验和。在 IPv6 中，校验和是强制性的。

校验和的计算基于伪头部（pseudo-header），伪头部包括源地址、目标地址、协议号（17，表示 UDP）、UDP 数据报长度和实际的 UDP 头与数据。

### **数据（Data）**
- **大小**：可变
- **用途**：UDP 数据报的有效载荷，即应用程序发送的实际数据。数据部分的大小取决于 UDP 数据报的总长度减去头部的 8 字节。

## 4. **UDP 的工作过程**

1. **数据封装**：应用层数据首先交给 UDP 协议进行封装，UDP 添加头部信息（源端口、目标端口、长度、校验和），然后将数据发送到网络层。
2. **传输**：UDP 数据报通过 IP 协议传输到目标主机，IP 层根据目标 IP 地址和协议类型（UDP 协议为 17）将数据转交给目标主机的 UDP 协议栈。
3. **接收与解封装**：接收方的 UDP 协议解封装数据报，剥离 UDP 头部，交给上层应用程序进行处理。

## 5. **UDP 的优缺点**

### 优点：
- **简单和高效**：由于没有连接建立和维护的过程，UDP 比 TCP 更加简单，适用于对延迟要求严格的应用场景。
- **低开销**：UDP 头部只有 8 字节，且没有复杂的拥塞控制和流量控制机制，减少了传输的开销。
- **广播和多播支持**：UDP 支持向一组主机广播或多播数据，这对于许多应用（如视频直播、广播、DNS 查询等）非常有用。

### 缺点：
- **不可靠性**：UDP 不保证数据的到达顺序或可靠性，数据包可能会丢失、重复或乱序。
- **无拥塞控制**：UDP 不具备 TCP 的拥塞控制机制，在网络拥堵时可能造成网络资源的浪费。
- **没有流量控制**：UDP 无法控制发送速率，因此可能会导致接收方处理不过来。

