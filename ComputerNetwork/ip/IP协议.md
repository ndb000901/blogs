# IP 协议

IPv4(Internet Protocol Version 4) 是互联网中最核心的协议之一，工作在 **网络层**（OSI 第三层），主要任务是：

> **把数据包从源 IP 地址传输到目的 IP 地址**，即实现主机之间的“寻址与路由”。

---

## 资料

- [wireshark下载](https://www.wireshark.org/download.html)
- [数据包下载](./packet/ip-demo.pcapng)
- `packet/ip-demo.pcapng` 使用wireshark 打开


## 1. IPv4 报文格式（共 20 字节的固定头 + 可选字段）

```text
  0                   1                   2                   3  
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1  
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |Version|  IHL  |Type of Service|        Total Length           |  0-3
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |        Identification         |Flags|     Fragment Offset     |  4-7
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |  Time to Live | Protocol      |       Header Checksum         |  8-11
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                     Source Address                            |  12-15
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                  Destination Address                          |  16-19
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                    Options (if IHL > 5)                       |  20+
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        Padding                                |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

---

## 2. 字段详解（20 字节固定部分）

| 字段名                 | 位数   | 说明 |
|------------------------|--------|------|
| **Version**            | 4      | 协议版本，IPv4 值为 4 |
| **IHL（首部长度）**    | 4      | 单位为 4 字节；最小值 5（20字节） |
| **Type of Service**    | 8      | 服务类型（QoS）/DSCP，现在用作服务质量分类 |
| **Total Length**       | 16     | 整个 IP 包长度（首部 + 数据）最大 65535 |
| **Identification**     | 16     | 分片时标识同一数据包 |
| **Flags**              | 3      | 位1：保留；位2：DF（不分片）；位3：MF（后面还有分片） |
| **Fragment Offset**    | 13     | 当前分片在原始数据包中的偏移（8字节为单位） |
| **TTL（Time To Live）**| 8      | 存活时间（每路由减1，为0就丢弃） |
| **Protocol**           | 8      | 上层协议号：6=TCP，17=UDP，1=ICMP 等 |
| **Header Checksum**    | 16     | IP头部的校验值，用于错误检测（仅头部，不含数据） |
| **Source Address**     | 32     | 源 IPv4 地址 |
| **Destination Address**| 32     | 目标 IPv4 地址 |
| **Options**（可选）    | 可变   | 用于如路由记录、安全等（很少用，最多 40 字节） |
| **Padding**            | 可变   | 填充至 4 字节对齐 |

---


### Protocol 字段常见值

| 值  | 协议         |
|-----|--------------|
| 1   | ICMP         |
| 6   | TCP          |
| 17  | UDP          |
| 89  | OSPF         |
| 47  | GRE          |

## 3. 分片机制简析

如果 IP 包太大（超过 MTU，如以太网通常为 1500），就要 **分片**：
- 所有分片有相同 `Identification`
- 除最后一片 `MF=1`（More Fragments）
- 偏移字段表示当前片段位置

---


