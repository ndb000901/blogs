# 三色标记(Tri-Color Marking)

[相关资料](https://en.wikipedia.org/wiki/Tracing_garbage_collection#Tri-color_marking)

**三色标记（Tri-Color Marking）** 是一种用于 **并发垃圾回收** 的算法，它通过对对象的标记状态进行分类来避免停顿时间，并提高回收效率。三色标记算法广泛应用于 **并发垃圾回收算法** 中，尤其是在 **Java虚拟机的G1 GC** 和 **CMS GC** 中，目的是实现 **低延迟的垃圾回收**，避免长时间的 **Stop-The-World** 停顿。

三色标记算法将对象分为三种状态：**白色（White）**、**灰色（Gray）** 和 **黑色（Black）**，每个颜色代表了对象的不同生命周期状态，目的是为了保证回收过程的安全性和高效性。

---

## **1. 三色标记的基本原理**

### **1.1 对象的三种颜色**
- **白色（White）**：表示对象是**不可达的**，即它在垃圾回收过程中未被标记过。所有初始对象都默认为白色。
- **灰色（Gray）**：表示对象是**可达的**，但它的子对象尚未被完全标记。灰色对象是**待处理的对象**，它们已经被标记为可达，但尚未遍历其引用的对象。
- **黑色（Black）**：表示对象已经**完全处理过**，即它不仅被标记为可达，而且它引用的所有对象也已经被标记。

### **1.2 状态转移规则**
- **白色 → 灰色**：当对象首次被标记为可达时，从白色变为灰色。
- **灰色 → 黑色**：当一个灰色对象的所有子对象都被标记为可达时，灰色对象转为黑色。
- **白色 → 被回收**：如果对象在标记过程中一直处于白色状态，说明它不可达，将被垃圾回收。

### **1.3 标记过程**
1. **初始阶段**：
   - 所有对象默认为白色（不可达）。
   - GC 会从 **根对象（GC Roots）** 开始，标记所有可达的对象为灰色。
   
2. **遍历阶段**：
   - GC 会遍历所有灰色对象，将它们的子对象标记为灰色，并将当前对象标记为黑色。
   - 继续处理所有未被处理的灰色对象，直到所有灰色对象都被遍历完成。

3. **回收阶段**：
   - 所有仍然是白色的对象都会被回收。
   - 已经被处理过的灰色和黑色对象会继续保留。

### **1.4 三色标记的回收过程示意图**

| 对象       | 初始状态 | 遍历中状态 | 完成后状态 |
|------------|----------|------------|------------|
| 根对象     | 白色     | 灰色       | 黑色       |
| 可达对象1  | 白色     | 灰色       | 黑色       |
| 可达对象2  | 白色     | 灰色       | 黑色       |
| 不可达对象 | 白色     | 无变化     | 被回收     |

---

## **2. 三色标记的工作流程**
### **2.1 标记过程**
1. **初始化**：所有对象都被标记为白色。
2. **标记根对象**：从 GC Root 开始，所有直接可达的对象会被标记为灰色。
3. **遍历灰色对象**：从灰色对象开始，遍历所有引用的对象，将它们标记为灰色，并将当前灰色对象标记为黑色。
4. **完成标记**：直到所有可达的对象都变为黑色。此时所有的白色对象就是不可达的，可以进行回收。

### **2.2 并发标记**
在并发垃圾回收中，GC 线程与应用线程并行工作。为了实现并发标记，采用了以下方法：
1. **初始标记**：首先由GC线程对GC Root进行标记，将所有直接可达的对象标记为灰色。
2. **并发标记**：在应用线程继续执行的同时，GC线程并发地遍历灰色对象，标记子对象为灰色。
3. **安全点同步**：在某些点，GC需要同步应用线程，确保灰色对象可以被正确处理。
4. **标记完成**：最后，所有的灰色对象变为黑色，白色对象被回收。

### **2.3 并发与暂停**
- 在 **并发标记** 阶段，应用线程和GC线程同时进行工作。这个过程会大大减少停顿时间。
- **暂停**（Stop-the-World）：为了保证标记过程的准确性，某些时刻会暂停应用线程，以保证灰色对象可以完全遍历。通常这些暂停是短暂的，尽量避免长期停顿。

---

## **3. 三色标记算法的优缺点**

### **优点**
1. **低停顿时间**：与传统的 **标记-清除** 或 **标记-整理** 算法相比，三色标记算法可以有效减少 **Stop-The-World** 的时间，尤其是在并发垃圾回收中。
2. **并发执行**：能够在应用线程与GC线程并发执行的同时完成标记过程，避免了大规模的暂停。
3. **较为高效**：在大型应用程序中，三色标记能够较高效地标记并清理垃圾对象，减少GC的停顿对性能的影响。

### **缺点**
1. **实现复杂**：由于并发垃圾回收需要在多线程环境下进行管理和协调，三色标记算法的实现相对复杂。
2. **需要额外的同步**：在并发阶段，GC需要与应用线程进行同步，确保对象的引用不被破坏，这可能增加一定的系统开销。
3. **标记过程可能长时间持续**：虽然标记过程并发执行，但在某些情况下，仍然可能因为大量对象需要标记而导致较长的延迟。

